<tool id="tb_profiler_collate" name="TB-Profiler Collate" version="0.1.0+galaxy0" profile="21.05">

  <description>Collate multiple TB-Profiler JSON reports into summary and variants reports</description>
  
  <requirements>
    <requirement type="package" version="6.6.5">tb-profiler</requirement>
    <requirement type="package">python</requirement>
  </requirements>

  <command detect_errors="exit_code"><![CDATA[
    #for $dataset in $input_files
        #set dataset_file_name = $dataset.element_identifier
        #if not dataset_file_name.endswith('.results.json')
            #set dataset_file_name = dataset_file_name + '.results.json'
        #end if
        ln -s '$dataset' '$dataset_file_name' &&
    #end for

    python '$__tool_directory__/replace_id_field_with_element_id.py' . &&

    tb-profiler collate --dir . &&

    cp tbprofiler.txt '$output_txt' &&
    cp tbprofiler.variants.csv '$output_csv' &&
    cp tbprofiler.variants.txt '$output_variants'
  ]]></command>

  <inputs>
    <param type="data_collection" name="input_files" label="TB-Profiler JSON Reports" collection_type="list" format="json" help="Enter a list of TB-Profiler JSON reports to collate."/>
  </inputs>

  <outputs>
    <data name="output_txt" format="txt" label="TB-Profiler Summary Report"/>
    <data name="output_csv" format="csv" label="TB-Profiler Variants Report (CSV)"/>
    <data name="output_variants" format="txt" label="TB-Profiler Variants Report (TXT)"/>
  </outputs>

  <tests>
      <test expect_num_outputs="3">
          <param name="input_files">
              <collection type="list">
                  <element name="ERR2510682" value="ERR2510682.results.json" ftype="json"/>
              </collection>
          </param>

          <output name="output_txt" file="tbprofiler_test_1_sample.txt"/>
          <output name="output_csv" file="tbprofiler_test_1_sample.variants.csv"/>
          <output name="output_variants" file="tbprofiler_test_1_sample.variants.txt"/>
      </test>
  </tests>

  <help><![CDATA[
  TB-Profiler Collate Tool

  This tool combines multiple TB-Profiler JSON reports into consolidated outputs, summarizing lineage, antimicrobial resistance (AMR) profiles, and variants across samples.

  Inputs
  - A collection of TB-Profiler JSON reports generated from individual samples.

  Outputs
  1. Summary Report (tbprofiler.txt): Overview of sample lineages and AMR predictions.
  2. Variants CSV (tbprofiler.variants.csv): Table of identified variants across all samples.
  3. Variants Text (tbprofiler.variants.txt): Text file of variant details for quick inspection.

  Usage Notes
  - Ensure all input JSON files are valid TB-Profiler outputs.

  References
  - TB-Profiler publication: DOI 10.1186/s13073-019-0676-5
  - TB-Profiler GitHub repository
  ]]></help>

  <citations>
      <citation type="doi">10.1186/s13073-019-0676-5</citation>
      <citation type="bibtex">@misc{TBProfilerGitHub, title={TB-Profiler GitHub repository}, howpublished={\url{https://github.com/jodyphelan/TBProfiler}}}</citation>
  </citations>

</tool>
